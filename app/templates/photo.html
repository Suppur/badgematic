{% extends "base.html" %}
{% block title %}Photo – Badgematic{% endblock %}
{% block content %}
  {% set step = 3 %}{% include "partials/_progress_steps.html" %}
  <div x-data="camera()" class="card bg-base-200 shadow mt-6">
    <div class="card-body">
      <h2 class="card-title">Prendre la photo</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <video id="cam" class="rounded-lg border w-full aspect-video bg-neutral/20" autoplay></video>
          <canvas id="snap" class="hidden"></canvas>
          <div class="mt-3 flex gap-2">
            <button class="btn" @click="start()">Activer</button>
            <button class="btn btn-primary" @click="shoot()">Prendre</button>
            <button class="btn" @click="retake()">Reprendre</button>
          </div>
        </div>
        <div>
          <form method="post" action="/photo">
            <input type="hidden" name="photo_data" x-model="photoData" />
            <img x-show="photoData" :src="photoData" class="rounded-lg border w-full" alt="aperçu" />
            <div class="mt-3 flex justify-end">
              <button class="btn btn-primary" :disabled="!photoData">Suivant</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
{% block scripts %}
<script>
function camera(){
  return {
    stream: null,
    photoData: "",
    async start(){
      this.stream = await navigator.mediaDevices.getUserMedia({ video: true });
      document.getElementById('cam').srcObject = this.stream;
    },
    shoot(){
      const v = document.getElementById('cam');
      const c = document.getElementById('snap');
      c.width = v.videoWidth; c.height = v.videoHeight;
      const ctx = c.getContext('2d'); ctx.drawImage(v, 0, 0, c.width, c.height);
      this.photoData = c.toDataURL('image/jpeg');
    },
    retake(){
      this.photoData = "";
    }
  }
}
</script>
{% endblock %}
